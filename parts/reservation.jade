template(name='reservation_view')
    with current_doc
        .ui.stackable.padded.grid
            .three.column.row
                .column 
                    with post
                        a.ui.fluid.large.button(href="/post/#{_id}/")
                            i.left.chevron.icon
                            |#{title}
                        +image_view key='image' label='image' direct=true
                        +comments
                .column 
                    .ui.header 
                        |viewing reservation
                    a.ui.header.inline.lowercase(href="/reservation/#{_id}/")
                        small from 
                        |{{cal_time start_datetime}}
                        small to 
                        |{{cal_time end_datetime}}
                    if complete 
                        .ui.large.green.label complete 
                    else 
                        .ui.large.label ongoing (incomplete)
                    .ui.small.header #{when} by #{_author_username}
                    .ui.header 
                        | #{hour_duration}
                        small hrs * $
                        |#{post.hourly_dollars}
                        small /hr = $
                        |#{cost}
                    .ui.header by #{_author_username}
                    +reservation_events
                .four.wide.column
                    if can_edit
                        a.ui.big.fluid.button(href="/reservation/#{_id}/edit" title='edit reservation')
                            i.pencil.icon
                            |edit
                    .ui.header 
                        |payouts
                    .ui.big.list
                        .item 
                            |#{hour_duration}hr * #{post.hourly_dollars}c/hr = #{cost}c
                        .item 
                            small 50% owner
                            |=#{owner_payout}c to #{post.owner_username}
                        .item.handler
                            small 45% handler
                            |=#{handler_payout}c to #{post.handler_username}
                        .item 
                            small 5% taxes
                            |=#{taxes_payout}c
    with current_doc
        .ui.stackable.padded.grid
            .four.column.row
                .column
                    // a.ui.circular.compact.button(href="/food/#{food_id}/")
                    //     i.left.chevron.icon
                    //     img.ui.avatar.image(src="{{c.url reservation_post.image width=200 height=200}}")    
                    //     |#{reservation_post.title}
                    a.ui.circular.compact.button.fly_left(href="/post/#{post_id}/")
                        i.left.chevron.icon
                        img.ui.avatar.image(src="{{c.url reservation_post.image width=200 height=200}}")    
                        |#{reservation_post.title} product
                    .ui.header view '#{reservation_post.title}' reservation
                    if can_edit
                        a.ui.large.circular.icon.button(href="/reservation/#{_id}/edit")
                            i.pencil.large.icon
                    .ui.header
                        i.clock.icon
                        |#{when}
                    .ui.header 
                        +i name='shop'
                        |item
                    .ui.segment 
                        with reservation_post
                            a(href="/post/#{_id}/")
                                img.ui.rounded.image(src="{{c.url image width=400 height=400}}")
                            a(href="/product/#{_id}/")
                                .ui.header #{title}
                            .ui.header #{serving_purchase_price} serving perchase price
                            //- .ui.header #{cook_tip} cook tip
                            .ui.header $#{reservation_total_transaction_amount} 
                                small total transaction amount
                    div
                .column
                    .ui.inline.header 
                        small available 
                        |{{from_now datetime_available}}:
                    +textarea_view key='description'
                    .ui.small.inline.header {{long_date datetime_available}}
                    // .ui.header ingredients
                    // each reservation_post.ingredients
                    //     .ui.label #{this}
                    // .ui.header #{servings_left} servings left
                    if can_edit
                        .ui.small.compact.button.cancel_reservation
                            i.remove.icon
                            |cancel
                    .ui.hidden.divider
                    +comments
                .column
                    .ui.header 
                        small buyer
                        strong #{_author_username}
                    with _author
                        +user_card
                    .ui.header 
                        small seller
                        strong #{_author_username}
                    with _author
                        +user_card


template(name='reservation_events')
    .ui.header
        i.rss.icon
        |reservation events
    .ui.bulleted.list
        each log_events
            .item #{text} #{when}

    
    
    
    
template(name='reservation_edit')
    with current_doc
        .ui.stackable.padded.grid
            .three.column.row
                .column 
                    // a.ui.big.fluid.button(href="/reservation/#{_id}/" title='save')
                    //     i.save.icon
                    //     //- +i name='submit-progress--v1'        
                    //     .ui.inline.header save draft     
                    .ui.header 
                        strong #{post.title}
                        small reservation
                    with post
                        .ui.inline.header #{daily_rate}c
                            small /day
                        |&nbsp;
                        |&nbsp;
                        +image_view key='image' label='image' direct=true cl='ui rounded image'
                    if can_buy
                        .ui.header 
                            small your balance
                            |{{fixed currentUser.credit}} 
                        .ui.header
                            small
                            //- | -  #{cost} 
                            | -  #{total_cost} 
                            if res_start_dropoff_selected
                                | + #{post.res_start_dropoff_fee}
                            if res_end_pickup_selected
                                | + #{post.res_end_pickup_fee}
                        .ui.header
                            small balance after purchase
                            small = 
                            //- small balance after purchase 
                            |#{member_balance_after_reservation}
                    else if need_credit
                        .ui.header need credit
                        .ui.header 
                            |{{fixed currentUser.credit}} 
                        .ui.header
                            small cost
                            | #{total_cost} 
                        .ui.header
                            small balance after purchase
                            small = 
                            |#{member_balance_after_reservation}
                    unless submitted
                        if can_buy
                            .ui.big.green.fluid.button.submit_reservation(class=submit_button_class)
                                |pay
                        else if need_credit
                            .ui.header #{member_balance_after_reservation} credit needed to purchase
                            .ui.inline.header add 
                            .ui.inline.input
                                input.adding_credit(type='number' value=member_balance_after_reservation) 
                            .ui.big.teal.fluid.button.add_credit(class=submit_button_class)
                                i.plus.icon
                                |add credit to reserve
                        else if need_approval
                            .ui.big.teal.fluid.button.request_reservation(class=submit_button_class)
                                |request reservation
                        else
                            .ui.big.disabled.fluid.button.send_message(title='cannot reserve for other reason')
                                |send message
                    else
                        .ui.header submitted {{ from_now submitted_timestamp }}
                        .ui.orange.fluid.button.unsubmit
                            i.undo.icon
                            |cancel
                    .ui.large.fluid.icon.button.cancel_reservation
                        i.ban.icon
                        |cancel/delete
                .column
                    img.ui.image(src="{{c.url reservation_post.image_id width=200 height=200}}")    
                    
                    .ui.header product 
                    with reservation_post
                        a.ui.small.header(href="/product/#{product_id}") #{title}
                        +image_view key='image' direct=true
                        +html_view key='description' direct=true
                    .ui.header 
                        small your credit: 
                        strong #{currentUser.points}pts
                    .ui.big.label
                        i.sun.icon
                        |daily rate: #{post_daily_rate}p/day
                    .ui.header 
                        small credit after purchase 
                        strong #{points_after_purchase}p
                    +date_edit key='reservation_date' label='reservation date' icon='calendar'
    
                .column
                    +textarea_edit key='notes' label='notes' direct=true
                    .ui.hidden.divider
                    if can_complete
                        a.ui.large.fluid.green.button.complete_reservation
                            i.checkmark.large.icon   
                            |complete reservation
                    else 
                        .ui.header not enough points
                        a.ui.large.fluid.green.disabled.button
                            i.checkmark.large.icon   
                            |complete reservation
                    .ui.hidden.divider
                    if in_dev 
                        +print_this
                    if can_delete
                        .ui.red.compact.button.delete_reservation
                            i.remove.icon   
                            |cancel
                    else  
                        .ui.red.disabled.button(title='existing reservations')
                            i.remove.icon   
                            | can't cancel  




template(name='user_reservations')
    .ui.header 
        +i name='reservation-history'
        |user reservations
    .scrolling
        each reservations 
            +profile_reservation_item

template(name='profile_reservation_item')
    .ui.segment.grid
        .row
            .four.wide.column
                with reservation_post
                    //- img.ui.mini.image(src=image)
                    +image_view key='image' direct=true cl='zoom ui tiny image'
            .twelve.wide.column
                .ui.header #{reservation_post.title}
                a.ui.small.header.inline.lowercase(href="/reservation/#{_id}/")
                    |#{reservation_amount}c
                .ui.small.inline.header #{when} by #{_author_username}
                a.ui.button(href="/reservation/#{_id}/")
                    |view
                    i.right.chevron.icon
                if is_admin
                    +remove_button




template(name='reservations')
    .ui.stackable.padded.grid
        .four.wide.column
            .ui.inline.header 
                +i name='reservation-history'
                |#{counter}
                |reservations
            div
            // .spacer
            .ui.icon.input
                i.search.icon
                input.query(type='text' placeholder='search...')
            .ui.inline.small.header
                i.marker.icon 
                |location tags
            each picked_location_tags
                button.ui.blue.compact.small.button.unpick_location_tag(tabindex='0')
                    //- i.remove.icon
                    | #{this}
            each location_tags
                button.ui.compact.small.button.pick_location_tag(tabindex="0" class=result_class title=count) #{title}
                    //- small #{count}
            div
            |sort by
            // +set_sort_key key='views' label='views' icon='eye'
            // // +set_sort_key key='datetime_available' label='available' icon='clock'
            // +set_sort_key key='price' label='price' icon='money'
            // +set_sort_key key='_timestamp' label='added' icon='clock'
            // +set_sort_key key='comment_count' label='comment count' icon='chat'
            // +set_sort_direction
            // |&nbsp;
            // |&nbsp;
            // +limit_menu
        .twelve.wide.column
            .sorting_row
                .ui.button today
                .ui.button tomorrow
                .ui.button this week
                .ui.button next week
                if selected_tag_plural
                    .ui.icon.black.compact.button.clear_picked_tags
                        i.remove.icon
                each picked_tags
                    button.ui.blue.compact.large.button.unselect_tag(tabindex='0')
                        //- i.remove.icon
                        | #{this}
                each tags
                    button.ui.compact.button.tag_result(tabindex="0" class=result_class title=count) #{title}
                        //- small #{count}
            .spacer 
            if subs_ready     
                .ui.stackable.three.centered.cards.scrolling
                    each reservation_docs
                        +reservation_card
                    unless reservation_docs.count
                        .ui.button.request_reservation
                            |request
                        each requests
                            .ui.header #{when}
            else 
                .ui.center.aligned.basic.segment
                    i.massive.yellow.notched.circle.loading.icon


template(name='reservation_card')
    .ui.card(class=reservation_card_class)
        a.image.fly_right(href="/reservation/#{_id}/") 
            img.ui.zoomer.pointer.goto_reservation.image(src="{{c.url image_id width=400 height=300 crop='pad'}}")
        .content
            a.ui.inline.header.zoomer.fly_right(href="/reservation/#{_id}/") 
                | #{title}
            .ui.inline.header #{daily_rate}p/day
            
            each tags
                a.ui.small.link.label.flat_pick_tag.spaced #{this}
            .right.floated.meta
                | #{when}
            unless anonymous
                a(href="/user/#{_author_username}")
                    img.ui.avatar.image(src="{{c.url _author.image_id width=400 height=600 crop='fit'}}")
                    |#{_author_username}
            // .ui.label #{inventory} units available
            // .ui.label #{reservation_total} total reservations
            if reservation
                +i name='deliver-reservation' cl='ui avatar image'
                if reservation_fee
                    .ui.inline.header(title='reservation fee') $#{reservation_fee}
            if open
                +i name='checkmark' cl='ui avatar image'
            else 
                i.ban.icon(title='not open to new reservations')
            // if can_edit
            //     a.ui.large.icon.button(href="/reservation/#{_id}/edit")
            //         i.pencil.icon
            if location_tags
                i.marker.icon
                each location_tags  
                    .ui.label #{this}
        //- .ui.bottom.attached.buttons        
        //-     .ui.green.button.quickbuy
        //-         i.lightning.icon
        //-         |buy
        //-     a.ui.button(href="/reservation/#{_id}/")
        //-         |view
        //-         i.right.chevron.icon

